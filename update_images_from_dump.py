
html_dump = """
<body><link rel="preload" as="image" imagesrcset="https://image.hm.com/assets/hm/03/ea/03ea2d0224a9e9121fe6adc6d89c6037462f05d2.jpg?imwidth=16 16w, https://image.hm.com/assets/hm/03/ea/03ea2d0224a9e9121fe6adc6d89c6037462f05d2.jpg?imwidth=1536 1536w"><link rel="preload" as="image" imagesrcset="https://image.hm.com/assets/hm/64/17/6417bde3c7f79f30842585ef3cbfc7674006bb68.jpg?imwidth=1536 1536w">
<article data-articlecode="0685816307" data-category="men_tshirtstanks_shortsleeve" class="fafa0f" aria-labelledby="_r_4g_"><div class="e6b4cd"><div class="b0fd0d"><a aria-hidden="false" href="/en_in/productpage.0685816307.html" title="Regular Fit T-shirt" class="bd47b4"><div class="ae5658"><div class="f1a9b4 b541f7 b47085" data-testid="next-image"><span style="box-sizing: border-box; display: block; overflow: hidden; width: initial; height: initial; background: none; opacity: 1; border: 0px; margin: 0px; padding: 0px; position: absolute; inset: 0px;"><img alt="Regular Fit T-shirt" srcset="https://image.hm.com/assets/hm/26/86/26860233c7f171415f6892a26067704486949fe0.jpg?imwidth=1536 1536w" src="https://image.hm.com/assets/hm/26/86/26860233c7f171415f6892a26067704486949fe0.jpg?imwidth=1536"></span></div></div></a></div>
<article data-articlecode="0685816053" data-category="men_tshirtstanks_shortsleeve" class="fafa0f"><div class="b0fd0d"><a aria-hidden="false" href="/en_in/productpage.0685816053.html" title="Regular Fit T-shirt"><img data-src="https://image.hm.com/assets/hm/36/91/369157f78ea0a36638ea42481d0723e9ca7cea58.jpg" srcset="https://image.hm.com/assets/hm/3e/97/3e978a4d4a838fc8caf5831f9c03b7aa8946ca62.jpg?imwidth=1536 1536w"></a></div>
<article data-articlecode="0685816290" data-category="men_tshirtstanks_shortsleeve"><a href="/en_in/productpage.0685816290.html" title="Regular Fit T-shirt"><img srcset="https://image.hm.com/assets/hm/33/54/3354004ab7cda37c2c1afb19b006bab508e09aa1.jpg?imwidth=1536 1536w"></a></article>
<article data-articlecode="1310165002" data-category="men_shirts_casual"><a href="/en_in/productpage.1310165002.html" title="Relaxed Fit Oxford shirt"><img srcset="https://image.hm.com/assets/hm/1e/c8/1ec84b3bd140fd69b7567fbd62d353ed1d484313.jpg?imwidth=1536 1536w"></a></article>
<article data-articlecode="0685816293" data-category="men_tshirtstanks_shortsleeve"><a href="/en_in/productpage.0685816293.html" title="Regular Fit T-shirt"><img srcset="https://image.hm.com/assets/hm/41/8e/418e2a67fe82494693545c2d0aee0668e8422111.jpg?imwidth=1536 1536w"></a></article>
<article data-articlecode="1337557002" data-category="men_shirts_casual"><a href="/en_in/productpage.1337557002.html" title="Regular Fit shirt"><img srcset="https://image.hm.com/assets/hm/c6/ed/c6edf66938931fe7213967117ce6ecd53de33337.jpg?imwidth=1536 1536w"></a></article>
<article data-articlecode="1330414001" data-category="men_tshirtstanks_polo_shortsleeve"><a href="/en_in/productpage.1330414001.html" title="Slim Fit Polo shirt"><img srcset="https://image.hm.com/assets/hm/8a/91/8a91d90a07e6dca0554ed9090918f6eb60759cc0.jpg?imwidth=1536 1536w"></a></article>
<article data-articlecode="1307417001" data-category="men_shirts_casual"><a href="/en_in/productpage.1307417001.html" title="Relaxed Fit Linen-blend shirt"><img srcset="https://image.hm.com/assets/hm/0b/7b/0b7b05dc57ded1a60d4aa47368d72ab7e5f657ea.jpg?imwidth=1536 1536w"></a></article>
<article data-articlecode="1316883001" data-category="men_jeans_relaxed"><a href="/en_in/productpage.1316883001.html" title="Relaxed jeans"><img srcset="https://image.hm.com/assets/hm/ac/7a/ac7a655bdbe1f794d41eca9835033c2ce3abe6c0.jpg?imwidth=1536 1536w"></a></article>
<article data-articlecode="1288186013" data-category="men_jeans_loose"><a href="/en_in/productpage.1288186013.html" title="Loose Straight Jeans"><img srcset="https://image.hm.com/assets/hm/33/e0/33e039160cd4978d30b1d7b77a5833fa6ed1a62c.jpg?imwidth=1536 1536w"></a></article>
<article data-articlecode="0972640174" data-category="men_tshirtstanks_shortsleeve"><a href="/en_in/productpage.0972640174.html" title="Loose Fit T-shirt"><img srcset="https://image.hm.com/assets/hm/6b/f7/6bf7d091e6ce962bb0c8b44e800e882bf13bbcd6.jpg?imwidth=1536 1536w"></a></article>
<article data-articlecode="0685816266" data-category="men_tshirtstanks_shortsleeve"><a href="/en_in/productpage.0685816266.html" title="Regular Fit T-shirt"><img srcset="https://image.hm.com/assets/hm/09/a1/09a1a9509f3add50890329ccb3c3cefe26e885af.jpg?imwidth=1536 1536w"></a></article>
<article data-articlecode="1253395001" data-category="men_trousers_casual"><a href="/en_in/productpage.1253395001.html" title="Slim Fit Tailored trousers"><img srcset="https://image.hm.com/assets/hm/db/57/db577720495912fd7a8c51473aa4c3c152bb29b7.jpg"></a></article>
<article data-articlecode="0972640159" data-category="men_tshirtstanks_shortsleeve"><a href="/en_in/productpage.0972640159.html" title="Loose Fit T-shirt"><img src="https://image.hm.com/assets/hm/ad/83/ad83b6d69d91958390c86339b8b6aace4d8683d9.jpg"></a></article>
<article data-articlecode="0970819001" data-category="men_hoodiessweatshirts_hoodies"><a href="/en_in/productpage.0970819001.html" title="Loose Fit Hoodie"><img src="https://image.hm.com/assets/hm/15/4f/154fc8cea8d1781a1700bcbd90ef1dbe506e4831.jpg"></a></article>
<article data-articlecode="1313924006" data-category="men_tshirtstanks_printed"><a href="/en_in/productpage.1313924006.html" title="Loose Fit Printed T-shirt"><img src="https://image.hm.com/assets/hm/55/36/55360f6af430a9167a9b0ccfb4dad368300018bb.jpg"></a></article>
<article data-articlecode="1257417002" data-category="men_shirts_longsleeved"><a href="/en_in/productpage.1257417002.html" title="Regular Fit Oxford shirt"><img src="https://image.hm.com/assets/hm/33/45/33458ce48302df12471fe84ce90995982f93dd10.jpg"></a></article>
"""

import re
import json
import os

def extract_and_update():
    # Extract Title -> Image URL mappings
    # Pattern to find title and nearby image source
    # We look for title="..." then later srcset="..." or src="..."
    
    # Simple regex approach might fail if attributes are ordered differently.
    # But usually in this dump they follow a pattern.
    
    # Better approach: split by <article and process each chunk
    articles = html_dump.split('<article')
    
    extracted_data = [] # List of {title, url}
    
    for art in articles[1:]: # Skip first empty chunk
        # Find title
        title_match = re.search(r'title="([^"]+)"', art)
        if not title_match:
            continue
        title = title_match.group(1)
        
        # Find image url
        # First check srcset
        img_match = re.search(r'srcset="([^"]+)"', art)
        if img_match:
            # srcset usually has "url size, url size". We want the last one or 1536w
            srcset = img_match.group(1)
            # Find the url with 1536w if possible
            # e.g ...jpg?imwidth=1536 1536w
            candidates = srcset.split(',')
            selected_url = candidates[-1].strip().split(' ')[0] # Fallback to last
            
            # search for explicit 1536
            for c in candidates:
                if '1536w' in c:
                    selected_url = c.strip().split(' ')[0]
                    break
        else:
            # Try src or data-src
            src_match = re.search(r'src="([^"]+)"', art)
            if not src_match:
                src_match = re.search(r'data-src="([^"]+)"', art)
            
            if src_match:
                selected_url = src_match.group(1)
            else:
                continue

        # Clean URL (remove query params if needed, but keeping imwidth is fine? usually we want imwidth=2160 or 1536)
        # If the URL is small, maybe we want to force higher res?
        # The user's dump has big urls.
        
        extracted_data.append({'name': title, 'url': selected_url})

    print(f"Extracted {len(extracted_data)} images from dump.")
    
    # Update products.json
    path = 'data/products.json'
    with open(path, 'r', encoding='utf-8') as f:
        data = json.load(f)
        
    men_products = data['products']['men']
    
    # We need to distribute these images to the products in `men_products`.
    # Many products might share the same name (e.g. "Regular Fit T-shirt").
    # We should assign a UNIQUE image to each product if possible.
    
    # Group extracted images by Name
    images_by_name = {}
    for item in extracted_data:
        if item['name'] not in images_by_name:
            images_by_name[item['name']] = []
        if item['url'] not in images_by_name[item['name']]: # Avoid dupes in extraction
            images_by_name[item['name']].append(item['url'])

    # iterate products
    updated_count = 0
    used_urls = set()

    for p in men_products:
        p_name = p['name']
        if p_name in images_by_name:
            candidates = images_by_name[p_name]
            # Try to find one not used
            chosen = None
            for url in candidates:
                if url not in used_urls:
                    chosen = url
                    break
            
            # If all used (or only 1 avail), reuse the first one? 
            # Or if we have multiple products with same name, we want to Rotate through them.
            if not chosen and candidates:
                # Pick one based on rotation or random to minimize "repeated-ness" if we have duplicates in product list
                # But strict uniqueness is better. 
                # If we ran out of unique images for this name, we have to reuse or keep existing.
                 chosen = candidates[0] 
            
            if chosen:
                p['image'] = chosen
                if 'image_list' not in p: p['image_list'] = []
                # append or replace? Replace to ensure correctness
                p['image_list'] = [chosen]
                used_urls.add(chosen)
                updated_count += 1

    with open(path, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=2)
        
    print(f"Updated {updated_count} products with images from dump.")
    os.system('node convert_data.js')

if __name__ == "__main__":
    extract_and_update()
